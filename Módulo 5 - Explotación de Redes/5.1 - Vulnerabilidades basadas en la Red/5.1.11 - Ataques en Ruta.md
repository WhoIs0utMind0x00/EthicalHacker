# 5.1.11 - Ataques en ruta
En un _ataque en ruta_ (anteriormente conocido como Man-in-the-Middle [MITM]), el atacante se coloca entre la línea entre dos dispositivos o personas que se comunican para escuchar a escondidas (es decir, robar datos confidenciales) o manipular los datos que se transfieren (por ejemplo, mediante la corrupción o la modificación de datos). Los ataques en ruta pueden ocurrir en la capa 2 o en la capa 3.<br>
_Ataque en ruta_<br>
<hr>

<img src="img/mitm.jpeg" width="75%" height="75%" style="border-radius:10px;"><br>

## Suplantación de ARP y envenenamiento de caché ARP
Es un ejemplo de ataque que conduce a un escenario de ataque en ruta. Un ataque de suplantación de ARP puede apuntar a hosts, conmutadores y enrutadores conectados a una red de capa 2 enevenenando los cachés ARP de los sistemas conectados a la subred e interceptando el tráfico destinado a otros hosts en la subred. El atacante falsifica las direcciones MAC de la capa 2 para que la víctima crea que la dirección de la capa 2 del atacante es la dirección de la capa 2 de su puerta de enlace predeterminada (10.2.3.4). Los paquetes que se supone que van a la puerta de enlace predeterminada son reenviados por el conmutador a la dirección de capa 2 del atacante en la misma red. El atacante puede reenviar los paquetes IP al destino correcto para permitir que el cliente acceda al servidor web (10.2.66.77).

## Suplantación de control de acceso a medios (MAC)
Es un ataque en el que un actor de amenazas suplanta la dirección MAC de otro dispositivo (generalmente un dispositivo de infraestructura, como un enrutador). La dirección MAC suele ser una dirección codificada en un controlador de interfaz de red. En entornos virtuales, la dirección MAC podría ser una dirección virtual (es decir, no asignada a un adaptador físico). Un atacante podría falsificar la dirección MAC de los sistemas físicos o virtuales para eludir las medidas de control de acceso o realizar un ataque en la ruta.

__NOTA__: Una mitigación común para los ataques de envenenamiento de caché ARP es utilizar la inspección del protocolo de resolución dinámica de direcciones (DAI) en los conmutadores para evitar la suplantación de las direcciones de la capa 2.<br>
Otro ejemplo de ataque en ruta de capa 2 implica colocar un conmutador en la red y manipular el protocolo de árbol de expansión (STP) para convertirlo en el conmutador raíz. Este tipo de ataque puede permitir que un atacante vea cualquier tráfico que deba enviarse a través del conmutador raíz.<br>
Un atacante puede llevar a cabo un ataque en ruta en la capa 3 colocando un enrutador dudoso en la red y luego engañando a los otros enrutadores para que crean que este nuevo enrutador tiene una mejor ruta que otros enrutadores. También es posible realizar un ataque en ruta comprometiendo el sistema de la víctima e instalando malware que pueda interceptar los paquetes enviados por la víctima. El malware puede capturar paquetes antes de cifrarlos si la víctima utiliza SSL/TLS/HTTPS o cualquier otro mecanismo. Una herramienta de ataque llamada _SSLStrip_ utiliza la funcionalidad en ruta para ver de manera transparente el tráfico HTTPS, secuestrarlo y devolver enlaces HTTP no cifrados al usuario en respuesta. Esta herramienta fue creada por un investigador de seguridad llamado Moxie Marlinspike. Puede descargar la herramienta desde el [Repositorio SSLStrip](https://github.com/moxie0/sslstrip).<br>

Las siguientes son algunas recomendaciones de seguridad adicionales de capa 2 para proteger su infraestructura:

- Seleccione una VLAN no utilizada (que no sea VLAN1) y utilícela como VLAN nativa para todos sus enlaces troncales. No use esta VLAN nativa para ninguno de sus puertos de acceso habilitados. Evite el uso de la VLAN1 en cualquier lugar porque es la predeterminada.
- Configurar administrativamente puertos de conmutador como puertos de acceso para que los usuarios no puedan negociar un enlace troncal; también deshabilita la negociación de enlaces troncales (es decir, no permite el protocolo de enlace troncal dinámico [DTP]).
- Limite la cantidad de direcciones MAC aprendidas en un puerto determinado mediante la función de seguridad de puertos.
- Controle el árbol de expansión para evitar que los usuarios o dispositivos desconocidos lo manipulen. Puede hacerlo mediante las funciones BPDU Guard y Root Guard.
- Desactive el Protocolo de Detección de Cisco (CDP) en los puertos que enfrentan redes desconocidas o no confiables que no requieren CDP para nada positivo. (CDP opera en la capa 2 y puede proporcionar a los atacantes inforamción que preferiría no divulgar).
- En un conmutador nuevo, apaque todos los puertos y asígnelos a una VLAN que no se use para nada más que un punto muerto. Luego, abra los puertos y asigne las VLAN correctas a medida que los puertos se asignan y se necesitan.
- Utilice __Root Guard__ para controlar qué puertos no pueden convertirse en puertos raíz para conmutadores remotos.
- Utilice DAI.
- Utilice IP Source Guard para evitar la suplantación de información de capa 3 por parte de los hosts.
- Implemente 802.1X cuando sea posible para autenticar y autorizar a los usuarios antes de permitirles comunicarse con el resto de la red.
- Utilice la detección del Protocolo de configuración dinámica de host (DHCP Snooping) para evitar que los servidores DHCP dudosos afecten la red.
- Utilice el control de tormentas para limitar la cantidad de tráfico de difusión o multidifusión que fluye a través de un conmutador. Un atacante podría realizar un ataque de _paquete de tormenta_ (o _tormenta de difusión_) para causar una condición DoS. El atacante hace esto enviando transmisiones excesivas de paquetes IP (a menudo tráfico de difusión) en una red.
- Implemente listas de control de acceso (ACL), como las ACL de capa 3 y capa 2, para el control del tráfico y la aplicación de políticas.

## Ataques de degradación
En un ataque de degradación, un atacante obliga al sistema a favorecer un protocolo de cifrado débil o un algoritmo de hash que puede ser susceptible a otras vulnerabilidades. Un ejemplo de vulnerabilidad y ataque de degradación es la vulnerabilidad de relleno de Oracle en cifrado heredado degradado (POODLE) en OpenSSL, que permitió al atacante negociar el uso de una versión inferior de TLS entre el cliente y el servidor. Puede encontrar más información en [Vulnerabilidad POODLE](https://www.cisa.gov/news-events/alerts/2014/10/17/ssl-30-protocol-vulnerability-and-poodle-attack).
POODLE era una vulnerabilidad específica de OpenSSL y ha sido parcheada desde 2014. Sin embargo, en la práctica, la eliminación de la compatibilidad con versiones anteriores suele ser la única forma de evitar otros ataques o fallas de degradación.
