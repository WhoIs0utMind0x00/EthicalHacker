# Ataques basados en Kerberos y LDAP
Kerberos es un protocolo de autenticación definido en RFC 4120 que Windows ha utilizado durante varios años. Kerberos también se utiliza en numerosas aplicaciones y otros sistemas operativos. El sitio web del Consorcio de Kerberos proporciona información detallada en [Kerberos](https://kerberos.org). Una implementación de Kerberos contiene tres elementos básicos:
- Cliente
- Servidor
- Centro de distribución de claves (KDC), que incluye el servidor de autenticación y el servidor de concesión de tiquetes.<br>
_Pasos de la autenticación Kerberos_<br>
<img src="img/auth_kerb.jpeg" width="75%" height="75%" style="border-radius:10px;">

__Paso 1__. El cliente envía una solicitud al servidor de autenticación dentro del KDC.
__Paso 2__. El servidor de autenticación envía una clave de sesión y un tiquete de concesión de tiquetes (TGT) que se utiliza para verificar la identidad del cliente.
__Paso 3__. El cliente envía el TGT al servidor de concesión de tiquetes.
__Paso 4__. El servidor de concesión de tiquetes genera y envía un tiquete al cliente.
__Paso 5__. El cliente presenta el tiquete al servidor.
__Paso 6__. El servidor concede acceso al cliente.

Active Directory utiliza el Protocolo ligero de acceso a directorios (LDAP) como protocolo de acceso. La implementación de LDAP de Windows admite la autenticación Kerberos. LDAP utiliza una estructura jerárquica de árbol invertido denominada árbol de información de directorio (DIT). En LDAP, cada entrada tiene una posición definida. El nombre distinguido (DN) representa la ruta completa de la entrada.<br>
Uno de los ataques más comunes es el ataque del tiquete de oro de Kerberos. Un atacante puede manipular los tiquetes Kerberos basándose en los hashes disponibles comprometiendo un sistema vulnerable y obteniendo las credenciales de usuario local y los hashes de contraseña. Si el sistema está conectado a un dominio, el atacante puede identificar un hash de contraseña de Kerberos (KRBTGT) para obtener el tiquete dorado.<br>
__CONSEJO__: _Empire_ es una herramienta popular que se puede usar para realizar tiquetes de oro y muchos otros tipos de ataques. Empire es básicamente un marco de trabajo posterior a la explotación que incluye un agente de Windows puro de PowerShell y un agente de Python. Puede descargar Empire y acceder a demostraciones, presentaciones y documentación en [Repositorio Empire](https://github.com/BC-SECURITY/Empire).<br>
_La herramienta Empire_<br>
<!-- Empire -->
<!--(Empire) > use module powershell/credentials/mimikatz/golden_ticket -->
```bash
(Empire) > use module powershell/credentials/mimikatz/golden_ticket
(Empire: powershell/credentials/mimikatz/golden_ticket) > options
                Name: Invoke-Mimikatz Golden Ticket
              Module:  powershell/credentials/mimikatz/golden_ticket
          NeedsAdmin: False
           OpsecSafe: True
            Language: powershell
  MinLanguageVersion: 2
          Background: True
     OutputExtension: None

Authors:
  @JosephBialek
  @gentilkiwi
Description:
  Runs PowerSploit's Invoke-Mimikatz function to generate a
  golden ticket and inject it into memory.

Comments:
 http://clymb3r.wordpress.com/ http://blog.gentilkiwi.com htt
 ps://github.com/gentilkiwi/mimikatz/wiki/module-~-kerberos
Options:

 Name   Required Value  Description
 ----   -------- ------ -----------
 CredID False           CredID from the store to use for ticket
                           creation.
 domain False           The fully qualified domain name.
 user   True             Username to impersonate.
 groups False           Optional comma separated group IDs for the
                          ticket.
 sid    False            The SID of the specified domain.
 krbtgt False           krbtgt NTLM hash for the specified domain.
 sids   False           External SIDs to add as sidhistory to the
                          ticket.
 id     False            id to impersonate, defaults to 500.
 Agent  True     None   Agent to run module on.
 endin  False           Lifetime of the ticket (in minutes).
                          Default to 10 years.
(Empire: powershell/credentials/mimikatz/golden_ticket) > 
```
Un ataque similar es el ataque del _tiquete de plata de Kerberos_. Los tiquetes plateados son tiquetes de servicio falsificados para un servicio determinado en un servidor en particular. El sistema de archivos de Internet común (CIFS) de Windows le permite acceder a archivos en un servidor en particular y el servicio HOST le permite ejecutar __schtasks.exe__ o Instrumentación de administración de Windows (WMI) en un servidor determinado. Para crear un tiquete plateado, necesita la cuenta del sistema (que termina en __$__), el identificador de seguridad (SID) para el dominio, el nombre de dominio completo y el servicio proporcionado (por ejemplo, CIFS, HOST). También puede utilizar herramientas como Empire para obtener la información relevante de un volcado de Mimikatz para un sistema comprometido.
Otra debilidad en las implementaciones de Kerberos es el uso de la delegación de Kerberos sin restricciones. La delegación de Kerberos es una función que permite que una aplicación reutilice las credenciales del usuario final para acceder a los recursos alojados en un servidor diferente. Por lo general, debe permitir la delegación de Kerberos solo si el servidor de aplicaciones es de confianza; sin embargo, permitirlo podría tener consecuencias de seguridad negativas si se abusa y, por lo tanto, la delegación de Kerberos no está habilitada de manera predeterminada en Active Directory.
