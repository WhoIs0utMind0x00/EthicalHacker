# 6.7.6 - Práctica de Laboratorio: Secuencias de Comandos entre Sitios
## Objetivos
En esta práctica de laboratorio, realizará ataques XSS reflejados y XSS almacenados contra DVWA (aplicación web vulnerable) a niveles de seguridad bajos, medios y altos.

### Parte 1: Realizar explotaciones de secuencias de comandos entre sitios reflejados
### Parte 2: Realizar explotaciones de secuencias de comandos entre sitios almacenados
 

## Trasfondo / Escenario
En esta práctica de laboratorio, realizará pruebas de penetración de una aplicación web para determinar si se ha diseñado de forma segura.

DVWA (Damn Vulnerable Web Application!) es una aplicación web PHP/MySQL. Está diseñada para ser vulnerable a ataques comunes para permitir que los profesionales de seguridad prueben sus habilidades y herramientas, y que los estudiantes y profesores aprendan y comprendan la seguridad de las aplicaciones web en un entorno legal.

DVWA ofrece cuatro niveles de seguridad: bajo, medio, alto e imposible. Cada nivel de seguridad requiere diferentes habilidades para realizar explotaciones. Los niveles de seguridad reflejan diferentes niveles de seguridad que los desarrolladores pueden codificar en sus aplicaciones. En esta práctica de laboratorio, realizará exploits en tres de los niveles de seguridad, Bajo, Medio y Alto, lo que le permitirá ajustar sus ataques para comprometerlos.

## Recursos necesarios

- Maquina Virtual Kali (Kali VM) personalizada para el curso de Pirata Ético
- Acceso a Internet

## Parte 1: Realizar explotaciones de secuencias de comandos entre sitios reflejados
Un ataque XSS reflejado es aquel en el que un script malicioso se refleja en el navegador del usuario desde un servidor web. El script se activa a través de un enlace en el que la víctima hace clic. Esto enviará una solicitud al sitio web que tiene una vulnerabilidad que permite la ejecución del script malicioso.

### Paso 1: Inicie sesión en DVWA
- Desde la VM Kali Linux, abra un navegador y navegue hasta la aplicación DVWA.
- Introduzca la siguiente URL en el navegador http://10.6.6.13.
- En la solicitud de inicio de sesión, introduzca las credenciales: admin/password.
### Paso 2: Realizar un ataque XSS reflejado con un nivel de seguridad bajo.
- Seleccione DVWA Security en el menú de la izquierda y seleccione Low en el menú desplegable Nivel de seguridad. Haga clic en Submit.
- Seleccione XSS (Reflected) en el menú de la izquierda.
- Escriba la cadena Reflected_Test en What's your name? y haga clic en Submit.
- Verá que aparece el mensaje Hello Reflected_Test.

- Introduzca CTRL+U en el teclado para ver el código fuente de la página.
- Busque la cadena Hello Reflected_Test ingresando CTRL+F para abrir un cuadro de búsqueda.
- La presencia de la cadena en el código fuente HTML de la página indica que los valores ingresados en un campo de texto de respuesta del usuario se insertan en el código fuente de la página. Esto indica al atacante que la página puede ser vulnerable a los ataques XSS reflejados.

- Cierre la ventana de código fuente y vuelva a la página Reflected XSS Vulnerability.
- Ingrese la siguiente carga útil en el campo What’s your name? y haga clic en Submit.

```HTML
    <script>alert("You are hacked!")</script>
```

- Aparecerá un cuadro emergente de alerta con las palabras You are hacked!. Esto significa que el sitio es vulnerable a ataques XSS reflejados y hemos explotado la vulnerabilidad con éxito.

- Seleccione y copie la URL de la página comprometida. Abra una nueva pestaña del navegador, pegue la URL en el campo URL y presione Enter.
- Debería ver aparecer la misma página web mostrando el cuadro emergente You are hacked!. Esto significa que si un usuario abre la URL, se ejecutará un script malicioso. El cuadro emergente se usa para simular un script malicioso en esta práctica de laboratorio.

- En un compromiso de piratería ética, intentaría insertar un script de prueba simple en los campos de entrada para ver si el script se ejecuta. Si es así, el sitio web es vulnerable a los ataques XSS reflejados. Luego, podría distribuir el enlace en un ataque de suplantación de identidad (phishing) para determinar el nivel de conocimiento de la seguridad entre los empleados de sus clientes.

### Paso 3: Realizar un ataque XSS reflejado en el nivel de seguridad medio.
Intentará el mismo ataque, pero esta vez el nivel de seguridad del sitio web será medio.

- Seleccione DVWA Security en el menú de la izquierda y seleccione Medium en el menú desplegable Nivel de seguridad. Haga clic en Submit.
- Seleccione XSS (Reflected) en el menú de la izquierda.
- Nuevamente, ingrese la siguiente carga útil en What's your name? y haga clic en Submit.

```HTML
    <script>alert("You are hacked!")</script>
```

- Verá una respuesta de saludo, pero esta vez no aparecerá ninguna ventana emergente. Esto indica que el script no se ejecutó. Tenga en cuenta que el script se muestra como texto literal.

- Podemos analizar el código en el backend del sitio web para investigar el motivo.

- Haga clic en el botón View Source en la parte inferior derecha de la página y revise el código PHP.<br>
**Nota**: En un servidor web real, no tendríamos acceso a este código fuente de back-end, pero sí en DVWS.

- Tenga en cuenta la línea:
```PHP
    $name = str_replace ( '<script>', '',$_GET[ 'name' ] );
```
- Este código fuente crea un filtro, con la función str_replace(), que elimina la etiqueta `<script>` en nuestra carga útil y la reemplaza con un valor nulo. Esto hace que el script de carga útil sea ineficaz, por lo que el ataque falló y no se muestra ninguna ventana emergente. Dado que este script solo filtra `<script>` en minúsculas, podemos intentar evitar el filtro utilizando una etiqueta diferente en la carga útil. Utilizaremos `<ScRipt>`.

- Cierre la ventana de código fuente y vuelva a la página Reflected XSS Vulnerability.
- Ingrese la siguiente carga útil en el campo What's your name? y haga clic en Submit.

```HTML
    <ScRipt>alert("You are hacked!")</ScRipt>
```

### Paso 4: Realizar un ataque XSS reflejado en un nivel de seguridad alto.
Se intentará el mismo ataque, pero esta vez el nivel de seguridad del sitio web será alto.

- Seleccione DVWA Security en el menú de la izquierda y seleccione High en el menú desplegable Nivel de seguridad. Haga clic en Submit.
- Seleccione XSS (Reflected) en el menú de la izquierda.
- Ingrese la siguiente carga útil en el campo What's your name? y haga clic en Submit. (Tenga en cuenta el uso de guiones bajos para reemplazar espacios).

```HTML
    <ScRipt>alert("You_are_hacked!")</ScRipt>
```

- Hay un mensaje de saludo y no hay un cuadro emergente de alerta. Nuevamente, podemos analizar el código fuente del back-end para investigar.

- Haga clic en el botón View Source y revise el código PHP.
- Tenga en cuenta la siguiente línea:

```PHP
    $name = preg_replace( '/<(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i', '', $_GET[ 'name' ] );
```
- En este código, el desarrollador utilizó una expresión regular para reemplazar cualquier forma de la etiqueta `<script>`, sin importar qué mayúsculas y minúsculas se utilicen, con un valor nulo.
- Para evitar este filtro, debemos utilizar otra etiqueta HTML en lugar de `<script>` para atacar el sitio.
- Cierre la ventana de código fuente y vuelva a la página Reflected XSS Vulnerability.

In- grese la siguiente carga útil en el campo What's your name? y haga clic en Submit. (Tenga en cuenta el uso de guiones bajos para reemplazar espacios).

```HTML
    <img src=x onerror=alert("You_are_hacked!")>
```

Esta vez aparecerá el cuadro emergente XSS. Hemos pasado por alto con éxito el filtro y hemos explotado la vulnerabilidad XSS reflejada en DVWA en seguridad de alto nivel.

## Parte 2: Realizar explotaciones de secuencias de comandos entre sitios almacenados
Con el exploit XSS almacenado , usted ingresa un script malicioso a través de la entrada del usuario y el script se almacena en el servidor de destino en un foro de mensajes, base de datos, registro de visitantes o campo de comentarios. Cuando un usuario visita el objetivo, el servidor lo expone al código malicioso.

### Paso 1: Realizar un ataque de XSS almacenado con un nivel de seguridad bajo
Explotar el XSS almacenado con un nivel de seguridad bajo es sencillo porque no existen medidas de seguridad. Puede simplemente enviar un `<script>` para lograr el exploit.

- Seleccione DVWA Security en el menú de la izquierda y seleccione Low en el menú desplegable Nivel de seguridad. Haga clic en Submit.
- Seleccione XSS (Stored) en el menú de la izquierda.
- Escriba la cadena XSS Test#1 en el campo Name* y escriba Stored XSS Test en el campo Message *. haga clic en Sign Guestbook.
- Introduzca CTRL+U en el teclado para ver el código fuente de la página. Ingrese CTRL+F para buscar las cadenas XSS Test#1 y Stored XSS Test.
- Ambas cadenas, XSS Test#1 y Stored XSS Test, estarán en el código fuente de la página, lo que indica que los dos campos de entrada pueden ser vulnerables a un ataque de XSS almacenado.

- Cierre la ventana de código fuente y vuelva a la página Stored XSS Vulnerability.
- Introduzca Test # 1 en el cuadro Name* e introduzca la siguiente carga útil en el cuadro Message * y haga clic en Sign Guestbook.

```HTML
    <script>alert("You are hacked!")</script>
```

- Aparecerá un cuadro emergente de alerta XSS con el mensaje "You_are_hacked!". Esto significa que el sitio era vulnerable a ataques XSS almacenados y hemos explotado la vulnerabilidad con éxito.

- Actualice la página. Si recibe una alerta, haga clic en Resend para mostrar la página. El cuadro emergente de alerta XSS aparecerá nuevamente.
- Debido a que la carga útil XSS se almacena en el libro de visitas, el cuadro emergente de alerta aparecerá cada vez que se actualice la página.

- Antes de continuar con el siguiente paso, borre la carga útil XSS de la página. Haga clic en Setup / Reset DB en el menú de la izquierda y, a continuación, haga clic en Create / Reset Database.
### Paso 2: Realizar un ataque de XSS almacenado con un nivel de seguridad medio
Se intentará el mismo ataque, pero esta vez el nivel de seguridad del sitio web cambiará a Medio.

No es difícil explotar el XSS reflejado con una seguridad de nivel medio. El uso de `<script>` será rechazado, pero cambiarlo a un caso diferente como `<ScRipt>` evitará la seguridad y logrará el exploit.

- Seleccione DVWA Security en el menú de la izquierda y seleccione Medium en el menú desplegable Nivel de seguridad. Haga clic en Submit.
- Seleccione XSS (Stored) en el menú de la izquierda.
- Escriba la cadena XSS Test#1 en el campo Name* y escriba Stored XSS Test en el campo Message *. haga clic en Sign Guestbook.
- Introduzca CTRL+U en el teclado para ver el código fuente de la página. Ingrese CTRL+F para buscar las cadenas XSS Test#1 y Stored XSS Test.
- Ambas cadenas estarán en el código fuente de la página, lo que indica que los dos campos de entrada pueden ser vulnerables a un ataque de XSS almacenado.

- Cierre la ventana del código fuente y vuelva a la página de la vulnerabilidad.
- Introduzca Test # 1 en el cuadro Name* e introduzca la siguiente carga útil en el cuadro Message * y haga clic en Sign Guestbook.

```HTML
    <script>alert("You are hacked!")</script>
```
- No debe aparecer ningún cuadro emergente. Actualizar la página tampoco debe provocar la aparición del cuadro emergente de alerta.

- Esto significa que hay un código en el backend que sanitiza la entrada del usuario en el campo Message * para evitar que se envíen los scripts. Puede ver la entrada modificada en el último cuadro de mensaje rectangular debajo de los campos de entrada.
- Haga clic en el botón View Source y revise el código PHP e investigue.
- Verá dos bloques de código con la palabra Sanitize. El primer bloque de código, bajo // Sanitize message input, contiene dos funciones de PHP para realizar la sanitización de las entradas. La función strip_tags() elimina todas las etiquetas html del campo de mensaje antes de almacenarlas en la base de datos. La función htmlspecialchars() convierte todos los caracteres especiales en entidades HTML equivalentes para que no se reflejen en el navegador.

- El segundo bloque de código, bajo // Sanitize name input, realiza la sanitización de la entrada en el campo Name *.
- Contiene la función str_replace() que reemplaza cualquier aparición de la etiqueta `<script>` con un valor nulo. Esto desactiva el script por completo.

- Podemos intentar eludir la seguridad en el campo Name * utilizando alguna otra carga útil que no contenga etiquetas `<script>`.

- Cierre la ventana del código fuente.
- Antes de ingresar cualquier carga útil en el campo Name *, se debe aumentar la restricción de longitud máxima de 10 caracteres en el campo. Esta es una configuración del lado del cliente, por lo que es fácil de cambiar con los siguientes pasos:
- Haga clic derecho en el campo Name * y seleccione Inspect. Esto abre la ventana Herramientas de Desarrollo Web y muestra el código fuente de la página.
- Busque y haga doble clic en maxlength en el origen de la página y cámbielo de 10 a 100. La propiedad maxlength está dentro de la etiqueta `<input>` para el campo de texto.
- Presione Enter en el teclado para aplicar los cambios.
- Cierre la ventana Herramientas del desarrollador web .
- Con la restricción maxlength modificada, la carga útil XSS ahora se puede ingresar en el campo Name *.

__Nota__: El cambio del parámetro maxlength no persiste. Si actualiza la página, por ejemplo, la configuración debe cambiarse nuevamente.

Regrese a la página de vulnerabilidades e ingrese la siguiente carga útil en el campo Name *.

```HTML
    <ScRipt>alert("You are hacked!")</ScRipt>
```

- En el campo Message *, puede escribir el texto que desee y hacer clic en Sign Guestbook.
- Aparecerá un cuadro emergente de alerta XSS con el mensaje "You_are_hacked!".

- Debido a que la carga útil XSS se almacena en el libro de visitas, el cuadro emergente de alerta aparecerá cada vez que se actualice la página o cada vez que otros usuarios la visiten.

- La ventana emergente confirma que ha explotado con éxito la vulnerabilidad de XSS almacenado en el nivel de seguridad medio.

- Antes de continuar con el siguiente paso, borre la carga útil XSS de la página. Haga clic en Setup / Reset DB en el menú de la izquierda y, a continuación, haga clic en Create / Reset Database.

### Paso 3: Realizar un ataque de XSS almacenado con un nivel de seguridad alto
Intentará el mismo ataque, pero esta vez el nivel de seguridad del sitio web se establecerá en Alto.

- En el nivel alto, el código de seguridad incluye en la lista blanca `<scripts>` y rechaza todo lo demás. Sin embargo, otras etiquetas, como svg, funcionarán.

- Seleccione DVWA Security en el menú de la izquierda y seleccione High en el menú desplegable Nivel de seguridad. Haga clic en Submit.
- Seleccione XSS (Stored) en el menú de la izquierda.
- Escriba la cadena Test#1 en el campo Name* y escriba Stored XSS Test en el campo Message * Haga clic en Sign Guestbook.
- Introduzca CTRL+U en el teclado para ver el código fuente de la página. Ingrese CTRL+F para buscar las cadenas Test#1 y Stored XSS Test.
- Tanto Test#1 como Stored XSS Test deben estar en el código fuente de la página, lo que indica que los dos campos de entrada pueden ser vulnerables a un ataque de XSS almacenado.

- Cierre la pestaña de código fuente de la página y vuelva a la página de la vulnerabilidad.
- Introduzca Test # 1 en el cuadro Name* e introduzca la siguiente carga útil en el cuadro Message * y haga clic en Sign Guestbook.

```HTML
    <ScRipt>alert("You are hacked!")</ScRipt>
```

- No aparecerá ningún cuadro emergente. Actualizar la página tampoco hará que aparezca el cuadro emergente de alerta.

- Esto significa que hay un código en el backend del sitio que sanitiza la entrada del usuario en el campo Message *.

- Haga clic en el botón View Source y revise el código PHP e investigue.
- Verá dos bloques de código. Como antes con la seguridad Media, el primer bloque de código, bajo // Sanitize message input, contiene dos funciones php para realizar la sanitización de la entrada. La función strip_tags() elimina todas las etiquetas html del campo de mensaje antes de almacenarlas en la base de datos. La función htmlspecialchars() convierte todos los caracteres especiales en caracteres HTML equivalentes para que no se reflejen en el navegador.

- El segundo bloque de código, bajo // Sanitize name input, está realizando la sanitización de la entrada en el campo Name *. Contiene la función preg_replace(). Esta función utiliza una expresión regular para reemplazar cualquier aparición de la etiqueta `<script>`, independientemente de si el carácter es mayúscula o minúscula, con un valor nulo.

- Podemos intentar eludir la seguridad en el campo Name * utilizando alguna otra carga útil que no contenga etiquetas `<script>`.

- Antes de ingresar cualquier carga útil en el campo Name *, será necesario cambiar la restricción de longitud máxima de caracteres en el campo, como se hizo anteriormente.
- Con la restricción maxlength modificada, la carga útil XSS ahora se puede ingresar en el campo Name *.

- Regrese a la página de vulnerabilidades e ingrese la siguiente carga útil en el campo Name *. (Tenga en cuenta el uso de guiones bajos para reemplazar espacios).

```HTML
    <svg onload=alert("You_are_hacked!")>
```

- En el campo Message *, puede escribir el texto que desee y hacer clic en Sign Guestbook.
- Aparecerá un cuadro emergente de alerta XSS con el mensaje "You_are_hacked!".

- Debido a que la carga útil XSS se almacena en el libro de visitas, el cuadro emergente de alerta aparecerá cada vez que se actualice la página.

- La ventana emergente confirma que ha explotado con éxito una vulnerabilidad de XSS almacenada en el nivel de seguridad alto.

- Antes de continuar con el siguiente paso, borre la carga útil XSS de la página. Haga clic en Setup / Reset DB en el menú de la izquierda y, a continuación, haga clic en Create / Reset Database.
### Paso 4: Realizar una explotación de iframe almacenado
- Seleccione DVWA Security en el menú de la izquierda y seleccione Low en el menú desplegable Nivel de seguridad. Haga clic en Submit.
- Seleccione XSS (Stored) en el menú de la izquierda.
- Escriba la cadena iframe en el campo Name* y escriba el siguiente mensaje en el campo Message *. haga clic en Sign Guestbook.

```HTML
    <iframe src="http://h4cker.org"></iframe>
```

- El sitio web de H4cker ahora debería mostrarse debajo del mensaje de prueba de iframe.

- Este es un exploit potente porque el actor de la amenaza podría enviar el navegador a un sitio web malicioso.

- Antes de continuar con el siguiente paso, borre la carga útil XSS de la página. Haga clic en Setup / Reset DB en el menú de la izquierda y, a continuación, haga clic en Create / Reset Database.

### Paso 5: Realizar un exploit de cookies almacenadas
Robar las cookies de los visitantes del sitio web tiene implicaciones de seguridad. Las cookies contienen información sobre cómo y cuándo los usuarios visitan un sitio web y, a veces, información de autenticación, como nombres de usuario y contraseñas. Sin las medidas de seguridad adecuadas, un actor de amenazas puede capturar cookies y usarlas para hacerse pasar por usuarios específicos y obtener acceso a su información y cuentas.

- Seleccione DVWA Security en el menú de la izquierda y seleccione Low en el menú desplegable Nivel de seguridad. Haga clic en Submit.
- Seleccione XSS (Stored) en el menú de la izquierda.
- Escriba la cadena cookie en el campo Name* y escriba el siguiente mensaje en el campo Message *. haga clic en Sign Guestbook.

```HTML
    <script>alert(document.cookie)</script>
```

- Se presentará un cuadro emergente con la cookie. Esta es una cookie que PHP utiliza para realizar un seguimiento de las sesiones en ejecución.

- Una explotación podría modificar el script XSS para que la cookie se envíe a otro destino en lugar de solo mostrarla.

- Haga clic en OK en el cuadro emergente.
- Intente robar cookies en los niveles de seguridad medio y alto mediante las técnicas que aprendió en esta práctica de laboratorio.